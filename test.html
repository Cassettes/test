<html>
<head>
	<title>Verovio Hello World! example</title>
	<script src="https://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/js/all.min.js" type="text/javascript"></script>
	<script src="https://unpkg.com/@tonejs/midi"></script>
	<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
	<script src='https://surikov.github.io/webaudiofontdata/sound/0000_JCLive_sf2_file.js'></script>
	<!-- <script src='https://surikov.github.io/webaudiofontdata/sound/0290_SBLive_sf2.js'></script> -->

	<style>
		.score {display: flex; flex-direction: column; align-items: center;}
		#header {height: 40px; display: flex; flex-direction: column; justify-content: space-between; width: 595px;  align-items: center; }
		.toolbar {width: 100%; display: flex; flex-direction: row; justify-content: space-between; align-items: center; flex: 1;}
		.toolbar > div {padding: 0 10px; color: #555; cursor: pointer;}
		.toolbar > div:hover {color: black;}
		#progress {height: 2px;}
		#svg_output > svg {width: 595px; height: 842px; box-shadow: 0 0 10px rgba(0,0,0,.1);}
	</style>
</head>

<body>
	<div class="score">
		<div id="header">
			<div class="toolbar">
				<div id="play" onclick="play_midi()"><i class="fas fa-play"></i></div>
				<div id="time"></div>
				<div id="transpose"><i class="fas fa-key"></i></div>
				<div id="download"><i class="fas fa-download"></i></div>
				<div id="enlarge"><i class="fas fa-expand"></i></div>
			</div>
			<div id="progress">
			</div>
		</div>
		<div id="svg_output" />
	</div>
	<script type="text/javascript">
		const url1 = "https://notation-1259785823.cos.ap-chengdu.myqcloud.com/sample-encodings-master/MEI_3.0/Music/Complete_examples/Aguado_Walzer_G-major.mei";
		const url2 = "https://notation-1259785823.cos.ap-chengdu.myqcloud.com/sample-encodings-master/MEI_3.0/Music/Complete_examples/Ahle_Jesu_meines_Herzens_Freud.mei";
		const xml1 = "https://notation-1259785823.cos.ap-chengdu.myqcloud.com/20161117%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6/%E4%B9%85%E7%9F%B3%E8%AE%A9/52%20%E6%82%AC%E5%B4%96%E4%B8%8A%E7%9A%84%E9%87%91%E9%B1%BC%E5%A7%AC.xml";
		const xml2 = "https://notation-1259785823.cos.ap-chengdu.myqcloud.com/20161117%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6/%E4%B9%85%E7%9F%B3%E8%AE%A9/10%20La%20Pioggia.xml";

		let isPlaying = false;
		let song = null;
		const AudioContext = window.AudioContext || window.webkitAudioContext;
		let audioContext = new AudioContext();
		const player = new WebAudioFontPlayer();
		let reverberator, compressor, offlineCtx, renderedBuffer, songBuffer;

		function setupOfflineCtx(offlineCtx) {
			reverberator = player.createReverberator(offlineCtx);
			compressor = offlineCtx.createDynamicsCompressor();
			compressor.threshold.setValueAtTime(-50, offlineCtx.currentTime);
			compressor.ratio.setValueAtTime(20, offlineCtx.currentTime);
			reverberator.output.connect(compressor).connect(offlineCtx.destination);
		}

		function convertDataURIToBinary(base64) {
			var raw = window.atob(base64);
			var rawLength = raw.length;
			var array = new Uint8Array(new ArrayBuffer(rawLength));
			for(i = 0; i < rawLength; i++) {
				array[i] = raw.charCodeAt(i);
			}
			return array;
		}

		function play_midi() {
			console.log(renderedBuffer)
			if (!renderedBuffer)  return;
			if (isPlaying == false) {
				isPlaying = true;
				$("#play").html("<i class=\"fas fa-stop\"></i>");
				console.log('!!!!')
				songBuffer = audioContext.createBufferSource();
				songBuffer.buffer = renderedBuffer;
				songBuffer.connect(audioContext.destination);
				songBuffer.start();
			} else {
				isPlaying = false;
				$("#play").html("<i class=\"fas fa-play\"></i>");
				songBuffer.stop();
				songBuffer.disconnect();
			}
		}

		let vrvToolkit = new verovio.toolkit();
		$.ajax({
			url: xml2,
			dataType: "text",
			success: function(data) {
				let svg = vrvToolkit.renderData(data, {});
				$("#svg_output").html(svg);
				let base64midi = vrvToolkit.renderToMIDI();
				let binary = convertDataURIToBinary(base64midi);
				song = new Midi(binary);
				let offlineCtx = new OfflineAudioContext(2, 44100*song.duration, 44100);
				setupOfflineCtx(offlineCtx);
				song.tracks.forEach(t => {
					let preset = t.instrument.percussion? player.loader.drumInfo(t.instrument.number) : player.loader.instrumentInfo(t.instrument.number);
					console.log(preset)
					player.loader.decodeAfterLoading(offlineCtx, preset.variable);
				})
				setTimeout(() => {
					song.tracks.forEach(t => {
						let channel = player.createChannel(offlineCtx);
						console.log(channel)
						channel.output.connect(reverberator.input);
						let preset = t.instrument.percussion? player.loader.drumInfo(t.instrument.number) : player.loader.instrumentInfo(t.instrument.number);
						t.notes.forEach(n => {
							player.queueWaveTable(offlineCtx, channel.input, window[preset.variable], n.time, n.midi, n.duration, n.velocity);
						})
					})
					offlineCtx.startRendering().then(buffer => {
						renderedBuffer = buffer;
						console.log(renderedBuffer)
					})
				}, 100)
			}
		});
	</script>
</body>

</html>